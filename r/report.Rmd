---
title: "Global Trends in Urban Cooling and Heating"
author: "Elliot Cohen, Henri Torbey, Michael Piccirilli, Yu Tian, Vijay Modi"
date: "March 19, 2015"
output:
  html_document:
    theme: journal
    toc: yes
  pdf_document:
    toc: yes
    toc_depth: 3
---

***

```{r setup, echo=FALSE, include=FALSE}
## set working directory
setwd("~/Google Drive/Global_Trends/GTUCH/")

require("knitr")
require("plyr")
require("ggplot2")
require("scales")
require("reshape2")
require("segmented")
require("lubridate")
require("gridExtra")
library("xtable")
require("rmarkdown")
require("sm")
# require("sparkTable")
# require("data.table") 
# require("pander") 
# require("scatterplot3d")


opts_chunk$set(fig.path='Figs/', fig.align="left", echo=FALSE, cache=FALSE, tidy=TRUE, tidy.opts=list(width.cutoff=60))

options(stringsAsFactors=FALSE)
```

```{r functions, echo=FALSE}
## function to create Figure/Table numbers
incCount <- function(inObj, useName)
{
    nObj <- length(inObj)
    useNum <- max(inObj) + 1
    inObj <- c(inObj, useNum)
    names(inObj)[nObj + 1] <- useName
    inObj
}
figCount <- c(`_` = 0)
tableCount <- c(`_` = 0)
## Use like this:
# figCounts <- incCount(figCount, "f.randomFigure")

# function to check for NAs and complete cases
check<-function(df)
{
  NAs<-sum(is.na(df))
  print(paste("NAs:", NAs)) # count NA's
  if (NAs>0) df[which(is.na(df)), ] # Show NA's, if any.
  cc<-complete.cases(df)  # check for missing values...
  print(paste("Complete Cases:", all(cc)))  # Given a set of logical vectors, are all of the values true?
}




############
## date.time
############
date.time <- function(df, time_zone=NULL){
  if (is.null(time_zone)) {
    time_zone = "US/Eastern" # default timezone
    }
  
  # conform column names to lower case
  colnames(df) <- tolower(colnames(df))
  
  # coerce yr, m, d, hr to Factor
  df[["yr"]] <- as.factor(df[["yr"]])
  df[["m"]] <- as.factor(df[["m"]])
  df[["d"]] <- as.factor(df[["d"]])
  df[["hr"]] <- as.factor(df[["hr"]])
  df[["min"]] <- as.factor(df[["min"]])

  # create Date
  df$date <- as.Date(paste(as.character(df$m), 
                           as.character(df$d),
                           as.character(df$yr), 
                           sep="-"),
                     format = "%m-%d-%Y",
                     tz = time_zone)
  
  # converte Date to Factor for compatability with ddply
  df$date <- as.factor(df$date) 
  
  # create POSIX date-time object
  df$date.time <- as.POSIXlt(paste(df$yr, 
                                   df$m,
                                   df$d,
                                   df$hr,
                                   df$min,
                                   sep="-"),
                             format="%Y-%m-%d-%H-%M",
                             tz= time_zone)
  # return POSIX to charachter representation
  df$date.time <- as.character(df$date.time)
  return(df)
  }

############
## latitutde.name
############
latitude.name <- function(df){
  for (i in 1:nrow(df)){
  if (df$lat[i]>(-23.5) & df$lat[i]<(23.5)) (df$lat.name[i] <- "tropics")
  if ((df$lat[i]>(-35) & df$lat[i]<(-23.5)) | (df$lat[i]>(23.5) & df$lat[i]<(35)) ) (df$lat.name[i] <- "sub-tropics")
  if (df$lat[i]>(35) | df$lat[i]<(-35)) (df$lat.name[i] <- "north")
  }
  return(df)
}

############
## latitutde.subset
############
latitude.subset <- function(df){
  for (i in 1:nrow(df)){
  if (df$lattitude[i]>(-23.5) & df$lattitude[i]<(23.5)) (df$lat.name[i] <- "tropics")
  if ((df$lattitude[i]>(-35) & df$lattitude[i]<(-23.5)) | (df$lattitude[i]>(23.5) & df$lattitude[i]<(35)) ) (df$lat.name[i] <- "sub-tropics")
  if (df$lattitude[i]>(35) | df$lattitude[i]<(-35)) (df$lat.name[i] <- "north")
  }
  LaT <- dlply(df, .(lat.name),subset)
  return(LaT)
}

############
## getSeg # To apply to hourly (with a "temperature" column) without 0-load and NAs
############
# This function is applied to the hourly df and returns, as a list, the lm and segmented elements for every city and/or year (to be specified in dlply). This function is applied in a dlply function with either .(city, lat) or .(city, lat, yr)
# Criteria (judgement calls): expand on quant < 7 and nrow(x) < 91
getSeg <- function(x) {
#   x <- hourly[hourly$city=="Tacoma" & hourly$yr==2010,]
  x <- ddply(x, .(city,yr,m,d), function(x) x[x$mw == max(x$mw),]) 
  if (nrow(x)<(91)) # if less than 3 month of data, omit
  {
    stop
  } else {
    quant <- quantile(x$temperature)[4]-quantile(x$temperature)[2]
    a <- mean(x$temperature)
    linear <- lm(mw~temperature,data=x)
    if (quant<6.8){
      return(linear)
    } else {
      segm <- segmented(linear, seg.Z=~temperature, psi=list(temperature=a), control=seg.control(display=FALSE))  
      return(segm)  
    }  
  }  
}


############
## getSeg.scaled # To apply to hourly (with a temperature column) without 0-load and NAs
############
# This function is applied to the hourly df and returns, as a list, the lm and segmented elements for every city and/or year (to be specified in dlply). This function is applied in a dlply function with either .(city, lat) or .(city, lat, yr)
# add argument scaled=true, data=x
getSeg.scaled <- function(x) {
  x <- ddply(x, .(city,yr,m,d), function(x) x[x$mw == max(x$mw),]) 
  if (nrow(x)<(91))
  {
    stop
  } else {
    quant <- quantile(x$temperature)[4]-quantile(x$temperature)[2]
    a <- mean(x$temperature)
    linear <- lm(scaled_mw~temperature,data=x)
    if (quant<6.8){
      return(linear)
    } else {
      segm <- segmented(linear, seg.Z=~temperature, psi=list(temperature=a), control=seg.control(display=FALSE))  
      return(segm)  
    }  
  }  
}


getSeg.hr <- function(x) {
#   x <- hourly[hourly$city=="Tacoma" & hourly$yr==2010,]
#   x <- ddply(x, .(city,yr,m,d), function(x) x[x$mw == max(x$mw),]) 
  if (nrow(x)<(91)) # if less than 3 month of data, omit
  {
    stop
  } else {
    quant <- quantile(x$temperature)[4]-quantile(x$temperature)[2]
    a <- mean(x$temperature)
    linear <- lm(mw~temperature,data=x)
    if (quant<6.8){
      return(linear)
    } else {
      segm <- segmented(linear, seg.Z=~temperature, psi=list(temperature=a), control=seg.control(display=FALSE))  
      return(segm)  
    }  
  }  
}

getSeg.hr.scaled <- function(x) {
#   x <- ddply(x, .(city,yr,m,d), function(x) x[x$mw == max(x$mw),]) 
  if (nrow(x)<(91))
  {
    stop
  } else {
    quant <- quantile(x$temperature)[4]-quantile(x$temperature)[2]
    a <- mean(x$temperature)
    linear <- lm(scaled_mw~temperature,data=x)
    if (quant<6.8){
      return(linear)
    } else {
      segm <- segmented(linear, seg.Z=~temperature, psi=list(temperature=a), control=seg.control(display=FALSE))  
      return(segm)  
    }  
  }  
}


############
## getCoef # To apply to the cc.list obtained from the above getSeg
############
# This function is applied to the cc.list list obtained by ddply and the avove getSeg. It extracts, in a data frame, the heating and cooling coefficients, threshold temperature, intercept and significance of both coefficients. 
getCoef <- function(x){
  if ((class(x)[[1]])[1]=="segmented"){
    intercept1 <- coef(x)[1] + coef(x)[2] * x$psi[2]
    data.frame(intercept=intercept1, heating=coef(x)[2], cooling=coef(x)[3], threshold.t=x$psi[2], sig.heating=summary(x)[[4]][14], sig.cooling=summary(x)[[4]][15])  
  } else if ((class(x)[[1]])[1]=="lm"){
    if (coef(x)[2]<0) {
    data.frame(intercept=coef(x)[1], heating=coef(x)[2], cooling=NA, threshold.t=NA, sig.heating=summary(x)[[4]][8], sig.cooling=NA)        
    } else {
    data.frame(intercept=coef(x)[1], heating=NA, cooling=coef(x)[2], threshold.t=NA, sig.heating=NA, sig.cooling=summary(x)[[4]][8])          
    }
  }  
}

filter <- function(x, y){  
# x <- hourly1[hourly1$city=="New York City" & hourly1$yr==2006,]
  # Remove 0 load values
  x$mw[x$mw==0] <- NA
  x <- na.omit(x) 

  # Remove city-yr that have less than 350 days of obs
  n <- nrow(x)/24
  if (n<350){
    x$city <- NA
    x <- na.omit(x)
  } 

  # Remove cities that have both unsigificant cooling and heating
  if (nrow(x)==0) {
    x <- NULL
    return(x)
  } else {
    if ( (is.na(y$sig.heating[y$city %in% x$city & y$yr %in% x$yr]) | y$sig.heating[y$city %in% x$city & y$yr %in% x$yr]>0.1) & (is.na(y$sig.cooling[y$city %in% x$city & y$yr %in% x$yr]) | y$sig.cooling[y$city %in% x$city & y$yr %in% x$yr]>0.1)  ) {
    x$city <- NA 
    x <- na.omit(x)
    x <- NULL
    return (x)
  } else {
    return (x)
  }
 }
}

get.energy <- function(x, y){
#   x <- hourly.filtered[hourly.filtered$city=="New York City" & hourly.filtered$yr==2012 & hourly.filtered$hr==03, ]
#   y <- gradients.hr.yr
  x <- droplevels(x)
  
  # Loading CC
  if ( is.na(y$sig.cooling[y$city%in%x$city & y$yr%in%x$yr & y$hr%in%x$hr]) | y$sig.cooling[y$city%in%x$city & y$yr%in%x$yr & y$hr%in%x$hr]>0.1) {
    cc <- 0
  } else {
    cc <- y$cooling[y$city%in%x$city & y$yr%in%x$yr & y$hr%in%x$hr]  
  }
  
  # Loading HC
  if ( is.na(y$sig.heating[y$city%in%x$city & y$yr%in%x$yr & y$hr%in%x$hr]) | y$sig.heating[y$city%in%x$city & y$yr%in%x$yr & y$hr%in%x$hr]>0.1) {
    hc <- 0
  } else {
    hc <- y$heating[y$city%in%x$city & y$yr%in%x$yr & y$hr%in%x$hr]  
  }
  
  # Loading threshold temperature
  if (is.na(y$threshold.t[y$city%in%x$city & y$yr%in%x$yr & y$hr%in%x$hr])){
    tt <- quantile(x$temperature, .05)[[1]]
  } else {
    tt <- y$threshold.t[y$city%in%x$city & y$yr%in%x$yr & y$hr%in%x$hr]
  }
  
  x$cooling <- 0
  x$heating <- 0
  
  for (i in 1:nrow(x)){
    diff <- x$temperature[i] - tt
    
    if (diff<0){
      if (hc<0){
      x$heating[i] <- hc*diff         
      } else if (hc>0) {
      x$cooling[i] <- abs(hc*diff)  
      } 
    } else if (diff>0) {
      if (cc<0){
      x$heating[i] <- cc*diff  
      } else {        
      x$cooling[i] <- cc*diff
      }
    }
    
  }
  
return(x)  
}

get.cdh.hdh <- function(x, y){
#   x <- hourly1[hourly1$city=="Dakar"&hourly1$yr==2014,]
#   y <- gradients.all.max.yr
  x <- droplevels(x)
  
  if (is.na(y$threshold.t[y$city%in%x$city & y$yr%in%x$yr])){
    tt <- quantile(x$temperature, .05)[[1]]
  } else {
    tt <- y$threshold.t[y$city%in%x$city & y$yr%in%x$yr]
  }
  
  x$diff <- x$temperature - tt
  
  cdh <- sum(x$diff[x$diff>0])
  hdh <- sum(abs(x$diff[x$diff<0]))
  
  data.frame(city=x$city[1], yr=x$yr[1], cdh=round(cdh,2), hdh=round(hdh,2), tt=round(tt,1))
}

get.cdh.hdh.standard <- function(x, y){
#   x <- hourly.temp
#   y <- 20
  
  x$diff <- x$temperature - y
  
  cdh <- sum(x$diff[x$diff>0])
  hdh <- sum(abs(x$diff[x$diff<0]))
  
  data.frame(city=x$city[1], yr=x$yr[1], cdh=round(cdh,0), hdh=round(hdh,0))  
}

get.tt <- function(x,y){
#   x <- hourly[hourly$city=="Delhi - BRPL"&hourly$yr==2011,]
#   y <- gradients.all.max.yr
  x <- droplevels(x)
  
  if (is.na(y$threshold.t[y$city%in%x$city & y$yr%in%x$yr])){
  tt <- quantile(x$temperature, .05)[[1]]
  } else {
  tt <- y$threshold.t[y$city%in%x$city & y$yr%in%x$yr]
  }
  
  data.frame(city=x$city[1], yr=x$yr[1], t.t=round(tt,2))  
}

```

```{r loading data, echo=FALSE}
## Load and Weather
setwd("~/Google Drive/global_trends/GTUCH/")
hourly.load <- read.csv("compiled_hourly_load.csv", header=TRUE)
hourly.wx <- read.csv("compiled_hourly_weather.csv", header=TRUE)

hourly <- merge(hourly.wx, hourly.load, by=c("city", "yr", "m", "d", "hr"))
hourly <- droplevels(hourly)

date <- as.Date(paste(as.character(hourly$m), 
                      as.character(hourly$d),
                      as.character(hourly$yr), 
                      sep="-"),
                format = "%m-%d-%Y",
                tz = NULL)

wday <- strftime(date, format="%w") # Weekday as decimal number (0–6, Sunday is 0).

hourly$date <- date
hourly$wday <- wday

# remove Australian states because they are not urban agglomerations (e.g. cities).
hourly <- hourly[!(hourly$city=="New South Wales" | hourly$city=="Queensland" | hourly$city=="South Australia" | hourly$city=="Victoria" ),]

# hourly will be filtered to contain only weekdays --> for segmented().
# hourly1 will contain all the data --> for energy calcs.
hourly1 <- hourly

hourly1 <- hourly1[,c("city","yr","m","d","hr","temp","mw")]
colnames(hourly1)[6] <- "temperature"
hourly1 <- na.omit(hourly1)

# subsetting by weekdays
hourly <- hourly[which(hourly$wday==1 | hourly$wday==2 | hourly$wday==3 | hourly$wday==4 | hourly$wday==5 ),]

# subset
colnames(hourly)[6] <- "temperature"
hourly <- subset(hourly, select=c("city", "yr", "m", "d", "hr", "temperature", "mw", "lat","scaled_mw")) #,"dew.point"

# Omit 0-load values 
hourly$mw[hourly$mw==0] <- NA
hourly <- na.omit(hourly)

## Population
population <- read.csv("population.csv",header=TRUE)

## Gradients
gradients.all.max.yr <- read.csv("gradients.all.max.yr.csv", header=TRUE)
gradients.all.scaled.max.yr <- read.csv("gradients.all.scaled.max.yr.csv", header=TRUE)
# Hourly gradients 
gradients.hr.yr <- read.csv("gradients.yr.hr.csv",header=TRUE)

hourly1.filtered <- ddply(hourly1, .(city, yr), function(x) filter(x, gradients.all.max.yr))
```

```{r missing-data, echo=FALSE, results='hide'}
which(! levels(as.factor(hourly$city)) %in% levels(as.factor(population$city)))
get <- which(! levels(as.factor(hourly$city)) %in% levels(as.factor(population$city)))
levels(as.factor(hourly$city))[get]

#  "Antigua" "Beirut" "Delhi - BRPL" "Delhi - BYPL" "Delhi - MES"  "Delhi - NDMC" "Delhi - NDPL" "Kano" "Kupang" "Tema"    
#  We can easily find these values... let's use them!
```

## Motivation
Many of the world's **largest** and **fastest-growing** cities--from Karachi (pop. 14 million; 34.6% increase from 2000-2010) to Delhi (22m; 39.4%), Dhaka (15m, 45.2%), Jakarta (10m; 14.8%), Bangkok (8m, 29.1%), Lagos (11m; 48.2%) and Kinshasa (9m, 55.4%)--are located in South Asia and Sub-Saharan Africa with tropical to sub-tropical climates unlike those of most OECD member cities in the global north. As the tropics/subtropics become increasingly urban, industrial and affluent, it is important to consider how energy demand -- particularly for thermal comfort -- will evolve differently in these places than it has historically across the OECD. 

To illustrate the potential for vast differences in energy demand for thermal comfort between cities in the global north and cities in the tropics/subtropics, consider Delhi, India. With its massive population, extremely hot summer and extraordinarily hot and humid monsoon season, Delhi is unlike any city in the global north, but typical of South Asia: Peak summer temperatures routinely exceed 40 °C. (104 F.), and intense heatwaves can approach 50 °C. (122 F.). Given the huge temperature differential between outdoor (say 104 F.) and desired indoor air temperature (say 72 F.), and the thermodynamic fact that energy for cooling scales linearly with the temperature differential, cooling a room in Delhi will require twice as much energy as cooling the same room in New York where summer outdoor-indoor temperature differentials are typically half that. 

In addition to higher temperatures, the cooling season is also much longer: in the past year, Delhi had nearly **six** times as many cooling-degree days as New York City (again assuming a desired indoor air temperature of 72 °F). Compounded by (a) leaky building envelopes in developing world cities (designed for natural ventilation, not air conditioning), (b) intense heat-island effects (typically less green space), and (c) massive population growth -- peak electricity demand in emerging megacities could one day surpass that of their neighbors to the north -- not only in aggregate terms because of their population, but also *per-capita* due to climate, building design and thermodynamics. 

Figure 1 provides a map of urbanization rates for cities worldwide with a population greater than 750,000 (UN 2011). Urbanization rates are clearly highest in South Asia and Sub-Saharan Africa. Figure 2 shows the *distribution* of population growth rates for the same set of cities, grouped by latitude (north, tropics and subtropics). The expected value (e.g. central tendancy) of urbanization rates in the tropics and subtropics is clearly distinct from that of the north. Cities in the tropics and subtropics represent a vast new market for energy services, including air conditioning, refrigeration, and consumer appliances.

```{r read_urbanization_data, warning=FALSE, eval=TRUE}
# setwd("~/Google Drive/Global_Trends/Data/UN_Population_Data/")
setwd("~/Google Drive/Global_Trends/GTUCH/")
load("cities.rsav") # population and growth rate data for global cities with pop > 750k
```

```{r urbanization_map_current, fig.width=10, fig.height=5}
# base map
world <- map_data("world")
worldmap <- ggplot(world, aes(x=long, y=lat, group=group)) +
  geom_path()

###### Plot Current Population and Urbanization Rates ######
ggplot() + 
  geom_path(data=world, alpha=0.5, size=0.2, aes(x=long, y=lat, group=group)) +
  geom_hline(y=-23.45, linetype=2, size=0.2) +
  geom_hline(y= 23.45, linetype=2, size=0.2) +
  geom_hline(y=-38, linetype=3, size=0.2) +
  geom_hline(y=38, linetype=3, size=0.2) +
  geom_point(data=subset(cities, Period=="2010-2015"), aes(x=Longitude, y=Latitude, colour=Growth.Quartile, size=Pop./10^3)) +
  coord_equal() +
  scale_y_continuous(breaks=(-2:2) * 30) +
  scale_x_continuous(breaks=(-4:4) * 45) +
  labs(colour = 'Urbanization Rate', size="Population (Millions)", title="Rapid Urbanization Throughout the Tropics and Subtropics") +
  theme_bw() +
  scale_color_brewer(palette="Reds") +
  scale_size(range = c(1, 10))
###### End Population and Urbanization Rates ######
```

```{r urbanization_map_evolution, eval=FALSE}
# base map
world <- map_data("world")
worldmap <- ggplot(world, aes(x=long, y=lat, group=group)) +
  geom_path()
mapWorld <- borders("world", colour="gray40", fill="gray40")

#####  Evolution over time (10-year) ######
# setwd("~/Google Drive/Global_Trends/Data/UN_Population_Data/")
load("cities.rsav") # synthesized population and growth rate data for global cities with pop > 750k

decadal <- ddply(cities, .(Continent, Country.Code, Country, City.Code, Urban.Agglomeration, Latitude, Longitude, decade), numcolwise(mean))
decadal$decade<-factor(decadal$decade, levels=c("Fifties", "Sixties", "Seventies", "Eighties", "Nineties", "Oughts", "Twenty-Teens", "Twenty-Twenties"))

ggplot() + 
  geom_path(data=world, aes(x=long, y=lat, group=group)) +
  mapWorld +
  geom_point(data=decadal, aes(x=Longitude, y=Latitude, colour=Growth, size=Pop./10^3)) + 
  facet_wrap(~decade, nrow=length(levels(factor(decadal$decade)))/2) +
  coord_equal() +
  scale_y_continuous(breaks=(-2:2) * 30) +
  scale_x_continuous(breaks=(-4:4) * 45) +
  labs(colour = 'Annual Population Growth (%)', size="Population (Millions)") +
  theme_bw() +
  scale_size(range = quantile(decadal$Pop., probs=c(0.0, 1)/500)) +
  scale_colour_gradient(low="white", high="red", limits=quantile(decadal$Growth, probs=c(0.0, 1))) 
```

```{r urbanization_PDF, fig.width=7, fig.height=4}
###### Begin Plot Population Growth Densities by Region ######
test<-subset(cities, Year==2015)
sm.density.compare(test$Growth, test$region, xlab="% Change (Annual)", xlim=quantile(test$Growth, probs=c(0.0,.99)))
title(main="Probability density of urbanization rates for three latitude groups")
colfill<-c(2:(2+length(levels(test$region)))) 
legend("topright", levels(test$region), fill=colfill)
###### End Plot Population Growth Densities by Region ######

## also show cooling degree days for cities in these regions..
```

### Global Energy Service Provision Parity
Urbanization, rising incomes, and the income elasticity of energy services in emerging economies will largely determine the trajectory of global energy demand (and associated environmental impacts) over the coming decades (Chaturvedi et. al 2014). As incomes rise, energy demand increases along the extensive margin as more households and businesses purchase energy-consuming assets for the first time (Gertler et al. 2013). As population rises, energy demand increases further along the extensive margin as the total number of households and businesses increases, producing a multiplicative effect (Commoner 1972). 

Along the intensive margin, households and businesses tend to trade-up the energy-intensity ladder: transitioning from fans to window-unit A/C to centralized A/C, from clothesline to spin-dryer to heated-dryer, from two-wheeler to compact car to SUV. Energy intensity may eventually come back down due to efficiency gains, but the process of turning over accumalted capital stock is long and slow.

The current trajectory of economic development in emerging-market cities is towards eventual parity with the OECD (Chaturvedi et. al. 2014). Energy demand will also tend towards parity with the OECD, but in terms of *service provision*, and not simply total per-capita BTU or kWh. Households and businesses do not demand energy _per-se_, but energy services such as thermal comfort (cooling, dehumidification and heating), food storage (refrigeration), food preparation (cooking, boiling, microwaving), cleaning (washing, drying), work productivity (mobile phones and computers), communication (mobile phones and computers), and entertainment (TV, mobile phones and computers). Thus, to even begin to accurately project future energy demand, we must start with a baseline assessment of current demand for energy services. 

This study aims to address that prerequisite by quantifying current demand for thermal comfort in major emerging cities, and providing benchmark comparison with mature urban economies in the OECD (mostly in the U.S. and Japan). We focus on thermal comfort as compared to other end-use energy services because it is by far the largest driver of electrical peak demand in the residential and commercial sectors (Segal et al. 1992; Crowley et al. 2003; McNeil and Letschert 2007).

The magnitude, timing, ramp-rate and ability to load-shift peak electrical demand will have huge implications on electricity grid planning, including capacity expansion, technology deployment, capital costs, operating costs, consumer prices, supply reliability and environmental impact. More broadly, it will have implications on the global transition to renewable energy given the limitations of meeting large and 'peaky' demand with non-dispatchable resources such as wind and solar.


### Drivers of Urban Electricity Demand 
In developed cities, building energy use accounts for roughly half of all greenhouse gas emissions attributable to that city (review of eight cities in the U.S. by Hillman and Ramaswami 2009). Specifically, electricity and heating fuel use in buildings generate (on average) as much GHG emissions as all surface trasportation, airline travel, upstream fuel processing, food production, cement manufacturing, potable water/wastewater treatment and long-distance freight combined that make life in cities possible (e.g. the flow of essential goods and services into and within cities; Hillman and Ramaswami 2009). Of the roughly 50% of urban GHG emissions attributalbe to building energy use, half of that (depending on climate) comes from electricity, with the other half coming from heating and industiral fuels (review of ten international cities by Kennedy et. al. 2010).

In developing cities, building energy use may account for a slightly smaller share of total city-wide GHG emissions, estimated at 43% for a case study of Delhi, India, using the same system boundaries and methodology as the aforementioned U.S. cities (Chavez et. al. 2012). 

#### Integrated Assessment Models
Eom et. al. (2012) identify five key variables that drive change in building energy use: (1) population growth, (2) economic growth, (3) urbanization, (4) per-capita floor space, and (5) demand for building energy services. This formulation is supported by Chatturvedi et. al. (2014), van Ruijven et. al. (2011), and serves as the foundation for a building energy sub-routine of the Global Change Assessment Model (GCAM), first developed by Edmonds and Reily (1983), and used widely in a long-lineage of studies since.

GCAM belongs to a class of models known as integrated assessment models, which  model a web of interactions between endogenous variables given exogenous boundary conditions (Edmonds and Reily 1983). Integrated assessment models such as GCAM are well-suited for high-level, economy-wide scenario analysis (see Wigley and Raper 1992; 2002, among many examples).

#### Physical-Based Models
On the other end of the [urban energy modeling] spectrum are custom-built, physical-based models that require detailed climatological, meteorlogical and building inventory data. Physical-based models are well-suited to answer specific inquiries regarding near-term energy use at high resolution. They do not attempt to model interactions with the broader economy. There are literally hundreds of such models in the literature, and therfore we only attempt a cursory catalog of salient examples. 

Building energy demand for thermal comfort (in particular) has been evaluated for many parts of the world:

* China (Wan et. al. 2010; Eom et. al. 2012)
* Hong Kong (Lam et. al. 2010)
* Malaysia (Saidur 2009)
* Jordan (Shariah et. al. 2009)
* Turkey (Eskin and Türkmen 2008)
* Europe (Bluysen et. al. 2011)
* Multiple regions (Lam et. al. 2010)

There have also been a large number of studies looking at the effect of climate change on heating/cooling demand in buildings:

* Australia (Wang et al 2010)
* Burkina Faso (Ouerdrago 2012)
* Switzerland (Frank 2011)
* Honk Kong (Lam et. al. 2010)
* UAE (Radhi 2009)
* Tehran (Delfani et al 2010)
* Germany (Olonscheck et al 2011)
* Multiple regions (Wan et al 2010)
* Subtropics (Wong et al 2010)
* Global (Wan et al 2009)
* Global (Isaac and van Vuuren 2009)
* Review article (Yao and Hasbi 2013)
* Review article (Li 2012)

A thrid category of urban energy demand models are statistical: regression, pure time-series, and mixed-method econometric models.

#### Regression Models
Daily and seasonal variability in urban electricity demand is caused, to a large degree, by demand for cooling and heating, which is driven by meteorological factors (Segal et al.,1992; Thatcher, 2007).

Segal et al. (1992) evaluated the relationship between summer peak energy demand in Israel and a host of meteorological parameters. Segal demonstrated that a simple linear model with just a few predictors, namely temperature and humidity, performs as well as more complex models with many additional predictors.

<Crowley et al. (2003) analyzed the role of climate change on electricity demand in both residential and commercial sectors, which are considered to be most sensitive to temperature. Using an observed temperature record, Crowley et al. (2003) estimated average energy demand increases of 3.8% in Pennsylvania, New Jersey and Maryland as a result of recent climate change.><Over what period?><what methods did they use?>

Thatcher (2007) built a complex demand forecast model with over 50 model parameters, but ultimately only require daily max/min temperature and relative humidity as input to estimate electricity demand. Thatcher's model takes daily max/min temperatures to estimate apparent temperature in 30-minute intervals using sine-exponential technique; then applies a modified linear regression model to predict electricity demand. The model is also applied to estimate how Load Duration Curves (LDC) change as a result of a 1 degree increase in the average temperature in Australian state capital cities.

All of these studies focus on detailed modeling for a particular mature utility and are therefore hard to generalize to other contexts. Our analysis draws upon consensus findings from the literature (e.g. electricity demand in urban areas is largely a function of temperature) to build our own streamlined urban electricity demand model. The purpose of our model is not precise prediction (we leave that to the electric utilities themselves), but rather a generalized framework that can be applied across multiple, data-sparse cities simultaneously with reasonable accuracy.

One notable example in this direction (besides our own attemp) is Wan et. al. (2011). Their study is similar in spirit to ours, but differs considerably in methodology. They estimate baseline and future heating and cooling demand for a generic air-conditioned office building in five Chinese cities representing five distinct climate zones. They apply a novel approach for extracting orthogonal (non-redundant) information from colinear meteorological data (dry bulb temperature, wet bulb temperature and solar radiation) via Principal Component Analysis, and then apply the first principal component in a regression framework to estimate heating and cooling loads. They compare results with a physical-based building energy model. <more on this.>

#### Time-Series and Econometric Models
Rallapalli and Ghosh (2012) apply a non-stationary time-series model to accurately predict energy demand in all 5 regional power grids of India. Their model out-performs official forecasts of the Central Electricity Authority of India for both in-sample and out-of-sample prediction.

Jung (1993), Fillipini (1999), Tiwali (2000), Fillipini and Pachauri (2004) and World Bank (2008) apply econometric approaches to estimate the income elasticity of electricity demand in Korea, Switzerland, India, India and India, respectively.

Econometric approaches can be catalogued into macro- and micro-level approaches. Macroeconomic approaches employ top-down, national/sub-national summary statistics (e.g. Bose and Shukla 1999; Chaturpuri et a. 2014), whereas microeconomic approaches use bottom-up household survey data to analyze across different heterogeneous sub-groups (e.g. Tiwari 2000; Pachauri 2004; The World Bank 2008).  

#### Special Considerations in Tropical and Sub-Tropical Cities
Pachauri and Spreng (2004) found that urban households in India change their energy consumption patterns with rising incomes. Households consume more energy per capita and move from less clean-burning energy sources such as biomass and kerosene to higher quality energy sources such as electricity and LPG. Both trends points towards higher peak electricity demand and higher integral energy consumption. 

Two excellent studies by the same author (Gupta 2012, 2014) provide insights into the effect of temperature on thermal-comfort seeking behavior in emerging economies. The first, Gupta (2012) adopted a semi-parametric coefficient model that allowed the temperature-electricity relation to vary over time for Delhi. His main findings were that electricity demand is a U-shaped function of temperature and that the cooling demand per unit increase in temperature (MW/°C) is increasing over time. Gupta (2014) applies a similar analysis to 28 Indian states, rather than a single city. Interestingly, Gupta found that the summer electricity demand temperature sensitivity is higher in hotter climate Indian states and conversely, winter electricity demand temperature sensitivity is higher in colder Indian states. He hypothesized that in hotter climates, people have more cooling equipment, and similarly, in colder states people have more heating equipment. He also conjectured that the effect of both hotter and colder weather on electricity demand sensitivity would be more pronounced with higher incomes and GDP/Capita. 

This study builds on the work of Gupta (2014) by conducting a global survey of heating and cooling demand, including emerging and developed cities in the US, India, West Africa, and South East Asia.


#### Quantitative Comparison with Previous Studies
Several previous studies have examined urban energy requirements for heating and cooling. Most relevant, Chaturvedi et. al. (2014) estimate building energy demand for India out to 2095. Chaturvedi et. al. (2014) take a top-down approach, applying national-average data on residential-commercial asset ownership and building square-footage coupled with a building energy service model from Eom et. al. (2012) and the Global Change Assessment Model (GCAM; Edmonds et. al. 1997). They wisely model urban buildings and rural buildings seperately, given divergent baseline conditions and trajectories. Broadly, Chaturvedi et. al. (2014) highlight the same themes as us: rapid urbanization in developing economies and the paramount importance of quantifying demand for energy services in those places. However, our specific findings for urban India differ substantially, as detailed in the discussion section.

Next, we compare our city-specifc results for Delhi and Chanidargh (India) with all-India urban averages from Chaturvedi et. al. (2014). We estimate per-capita electricity consumption for cooling to be 370 kWh/(capita x year) for NCT Delhi (see Result 6)[^1]. By comparison, applying values reported in Chaturvedi et. al. (2014) for all-India urban household energy consumption for cooling, and scaling by the number of households in Delhi (Chavez et al. 2012) and the average number of people per household (Delhi Statistical Abstract 2012), their estimate is equivalent to 36 kWh/(capita x year) -- an order of magnitude smaller than our empirical estimate.

Similarly, applying Chaturvedi et. al. (2014) estimates (see Table 3), the average cooling load in Delhi would be equivalent to approximately 423 MW. We estimate peak demand for cooling at 5359 MW. By our estimation, Chaturvedi (2014) may be underestimating building-energy demand for cooling in Indian cities by an order of magnitude.  It should be noted that our estimate is for peak cooling demand, and Chaturvedi (2014) is for average cooling demand. However, the magnitude of difference is still far larger than attributable to this alone. Assuming an average cooling day in Delhi is just 10 °C above a 21 °C threshold temperature, that would still yield a cooling demand of approximately 1300 MW (see result 1).

## Objectives
Energy demand projections abound, but are often saddled with excessive complexity (Bhattacharyya and Timilsina 2009). Complexity results in proliferation of model parameters, which in turn must be estimated, which in turn introduces multi-dimensional uncertainty, reduces degrees of freedom, diminishes generalizability and obfuscates interpretability. 

A review of multi-decadal energy demand forecasts for the U.S. economy were found to be consistently off the mark (Craig et al. 2002). Forecasts by the U.S. Department of Energy for 1975 to 2000 overestimated demand by up to a factor of 2. In fact, of a dozen independent energy forecasts evaluated, only one (Lovins 1979) proved accurate. "A perception that a complex model with extensive input data produces more accurate results might not be always true" (Bhattacharyya and Timilsina 2009, pg 8). The importance of parsimony in energy modeling cannot be overstated (Armstrong, 2001).

To side-step many of these pitfalls, we propose a well-defined, theory-driven and empirically-supported iterative regression model for estimating urban electricity demand. 

Broadly speaking, population and economic size drive baseload electricity demand at annual to decadal timescales; climate drives seasonal variability; and human physiology and meteorology drive diurnal patterns. This study considers the latter three -- climate, weather and human physiology -- in the context of demand for indoor thermal comfort. Although electricity represents just a third of total primary energy use (U.S. average, see <Chavez and Ramaswami 2012>), it is the most dynamic energy end-use sector. Rapid advances in cost-parity renewable generation, energy storage, real-time monitoring and active demand-side management make the electricity sector primed for a revolution.

The objective of this study is to answer four key research questions:

1. What is the current level of electricity demand for heating and cooling services in major emerging cities, as measured by MW/°C above a known threshold temperature? 
2. What is the magnitude of seasonal energy consumption for heating and cooling in major emerging cities, as measured by total GWh?
3. How do per-capita heating and cooling demand compare across cities, as measured by W/(°C x capita)?
4. How does the share of annual energy consumption used for heating and cooling compare across cities, as measured by a fraction of the total? 


## Data
At present, there is scant baseline information publically-available on urban electricity demand for a cross-section of global cities. This article aims to fill that gap. In addition to the tables, figures and analysis reported here, all of the underlying data is curated and made freely available (with citation) on [github](https://github.com/Ecohen4/Energy). We encourage fellow researchers to [fork](https://help.github.com/articles/fork-a-repo/) the repository and contribute new data via [pull request](https://help.github.com/articles/using-pull-requests/). 

This study combines high resolution (hourly) electricity demand and meteorological data with annual census information for 40 global cities.

The starting point for identifying major emerging cities was the UN World Urbanization Prospects (2014), subset to the 100 fastest growing cities with more than 2M inhabitants. For comparison, data for US cities was collected from the Federal Energy Regulatory Commission and the US Energy Information Administration. 


| City           | Country             | Load          | Weather       | Population    |
|----------------|---------------------|---------------|---------------|---------------|                     
| Abidjan        | Cote d'Ivoire       | 2010-2013 (a) | 2010-2013 (m) | 1990-2030 (n) |
| Accra          | Ghana               | 2013-2014 (b) | 2010-2013 (m) | 1990-2030 (n) |
| Amman          | Jordan              | 2011-2014 (c) | 2010-2013 (m) | 1990-2030 (n) |
| Antigua        | Antigua and Barbuda | 2011-2011 (d) | 2010-2013 (m) |     -         | 
| Beirut         | Lebanon             | 2011-2014 (e) | 2010-2013 (m) | 1990-2030 (n) |
| Chandigarh     | India               | 2011-2013 (d) | 2010-2013 (m) | 1990-2030 (n) |
| Dakar          | Senegal             | 2011-2014 (f) | 2010-2013 (m) | 1990-2030 (n) |
| Delhi          | India               | 2012-2013 (e) | 2010-2013 (m) | 1990-2030 (n) |
| Kano           | Nigeria             |    2014   (d) |    2014   (m) | 1990-2030 (n) |
| Kupang         | Indonesia           |    2013   (d) |    2013   (m) |    2011   (p) |
| Manila City    | Philippine          | 2011-2013 (g) | 2010-2013 (m) | 1990-2030 (n) |
| Mbabane        | Swaziland           | 2012-2014 (h) | 2010-2013 (m) |    2010   (p) |
| Nairobi        | Kenya               | 2011-2013 (i) | 2010-2013 (m) | 1990-2030 (n) |
| New York City  | U.S.                | 2007-2012 (d) | 2007-2012 (m) | 2007-2012 (q) |
| Philadelphia   | U.S.                | 2009-2011 (r) | 2009-2011 (m) | 1990-2030 (n) |
| Singapore      | Singapore           | 2013-2013 (j) | 2010-2013 (m) | 1990-2030 (n) |
| Tema           | Ghana               | 2012-2013 (b) | 2010-2013 (m) |     -         |
| Tokyo          | Japan               | 2008-2014 (k) | 2010-2013 (m) | 1990-2030 (n) |
| U.S. cities    | U.S.                | 2006-2013 (l) | 2010-2013 (m) | 2001-2013 (o) |

(a): Autorite Nationale de Regulation du Secteur de l'Electricite 
(b): Ghana Grid Company 
(c): National Electric Power Company 
(d): Sustainable Engineering Lab
(e): Electricite Du Liban
(f): Senelec
(g): Philipine Electricity Market Corporation
(h): Swaziland Electricity Company
(i): Kenya Power and Lighting Company
(j): Energy Market Authority
(k): Tokyo Electric Power Company
(l): FERC & EIA
(m): National Oceanic and Atmospheric Administration
(n): United Nations World Urbanization Porspects - 2014
(o): US Bureau of Economic Analysis
(p): UN Data
(q): US Census Bureau
(r): PJM

#### Weather Data
High-resolution weather data are indispensable to accurate energy demand forecasts (Segal et al. 1992; Sailor 2001; Crowley et al. 2003; Thatcher 2007). Fortunately, national weather services and climate information centers such as the U.S. National Oceanic and Atmospheric Administration (NOAA), Britain's Met Office, and India's Institute for Tropical Meteorology (IITM), collect, curate, analyze and publish meteorological data from thousands of weather stations worldwide. 

NOAA offers a wealth of meteorological information through the NCDC data portal. The data is available on the [Online Climate Data Directory](http://www.ncdc.noaa.gov/cdo-web/) website. It is also available via FTP, which is more efficient for batch queries, and is the method used here. 

However, handling large meteorological datasets can be unwieldy to the uninitiated. To address this issue and make meteorological data more accessible to a wider range of scientists, engineers and practitioners, we developed the `weatheR` library for the statistical computing language R. The `WeatheR` library dramatically simplifies, streamlines and improves the reproducability of our current work. Complete methodological details, step-by-step instructions and example vignettes are available on our [github page](http://ecohen4.github.io/Cohen-McCreight/weatheR.html).

Briefly, weather data was collected as follows:

* Cities of interest are geo-referenced via the Google Maps API.
* City coordinates are passed into a nearest-neighbor search algorithm to the find the k-nearest active weather stations.
* "Best" neighbor is selected from the k-nearest neighbors using multi-objective criteria of geographic proximity and completeness of the meteorological record.
* "Best" meteorological record is chosen, subset, scrubbed and interpolated to yield hourly temperature and humidity observations for each city and period of interest.

Applying the functions of the weatheR library to the cities and years for which load data was collected, hourly temperature time-series were obtained. The below boxplot shows the temperature distributions for these cities. 

```{r ,fig.width=7, fig.height=7, echo=FALSE}

wx.stats <- hourly[,c("city","temperature")] #, "dew.point"
wx.stats <- melt(wx.stats, id.vars="city")
cities <- c("Delhi - BRPL", "Delhi - BYPL", "Delhi - NDPL", "Delhi - MES", "Delhi - NDMC")
wx.stats <- wx.stats[!wx.stats$city %in% cities,]

ggplot(aes(y = value, x = city, fill = variable), data = wx.stats) + 
  geom_boxplot( outlier.size = 0) +
  coord_flip() + 
  labs(y="Temperature [°C]", x="City") +
  theme_minimal()

```

#### Demand Data
Hourly electricity demand data was collected from utility companies, system operators or electricity regulatory bodies serving the cities of interest. Data was collected for the past 3 years, if possible.

Data was obtained for 18 non-OECED cities and 21 OECD cities. [Note: The National Capital Territory of Delhi (population 23 million) is served by five geographically-distinct distribution companies and is thus considered as five separate cities].

Data for Beirut, Lebanon and Amman, Jordan were estimated from national data. The Jordanian utility NEPCO provided monthly ratios of energy consumption for Amman compared to Jordan as a whole. The ratio was approximately 50% for all the months. Amman is the only major city in Jordan.

The Lebanese utility EDL provided ratios of 15% from 8am to 12am, and 22% from 12am to 8am for Beirut. Comparing the two cities, which are less than 150 miles apart as the crow flies, yields surprisingly low per-capita consumption for Beirut (XX/kWh/capita/yr) compared to Amman (XX Kw/capita/yr). However, the allocation ratios, and thus the per-capita estimates, makes sense when you consider that there are several major cities in Lebanon (Beirut, Zahle, Tripoli and Saida), whereas Jordan has only Amman. Therefore, despite the similarity in electricity demand between Jordan and Lebanon at the national-scale, applying utility-supplied ratios yields significantly higher per-capita demand for Amman compared to Beirut. 

Data for Abidjan, Ivory Coast and Dakar, Senegal were estimated from country level loads by the utilities themselves. Monthly ratios of peaks at city-level feeders to peaks at grid-level were applied. 



#### Population Data
Population data was collected from the UN World Urbanization Prospects (2014) and from the US Bureau of Economic Analysis. It is used to normalize energy demand and consumption to a per capita level, as per the *Methods* section. 


## Methods

Two main analyses are performed on the set of city-year data, described above. The first one consists of estimating the sensitivity of the daily peak demand of electricity to ambient temperature, and the second consists of estimating the amount of energy consumed for thermal-comfort seeking (cooling and heating). The below sections detail the key concepts and methodology used to obtain these estimations. 

### Cooling/Heating Degree Hours (CDH/HDH)

For every city/year combination, Cooling Degree Hours is defined as the sum at every hour of the difference between the recorded temperature and a certain 'comfortable' temperature at which no cooling nor heating is required. If this difference is negative, it is taken as 0, as per the below formula: 

$$
{CDH} = \sum_{hour=1}^{8760} max\left \{ T_{observed,hour} - T_{threshold}, 0 \right \}
$$

In a similar way, Heating Degree Hours is defined as the sum at every hour of the difference between a certain 'comfortable' temperature and the observed temperature at that hour. If this difference is negative, it is taken as 0:

$$
{HDH} = \sum_{hour=1}^{8760} max\left \{ T_{threshold} - T_{observed,hour}, 0 \right \}
$$

In other words, CDH and HDH represent the number of degrees per year that require respectively cooling and heating to reach the degree of thermal-comfort set by the 'comfortable' temperate. This temperature is usually set at 20 °C, however the subsequent sections will derive a threshold temperature that is specific for the city-year considered. 


### Temperature-Load Curve (TLC) & Threshold Temperature (Tt)

Starting with the pairwise observations of hourly temperature and energy demand (MW) the temperature-load profile of every city-year-hr combination can be obtained. Each year is evaluated separately to estimate change over time, ceteris-paribus. Each hour of the day (1-24) is evaluated separately to control for natural diurnal rhythms, that is, demand will tend to be higher at 7pm than 3am, irrespective of the weather. Separate city-year-hr models also allows for checking the stability of results across multiple models.

Iterative testing has shown that to obtain a solid profile suitable for a regression fit, temperature-load data must be available for at least the equivalent of 3 months to capture a wide range of temperatures. Therefore, all the collected data were filtered to this criteria and a small number of city-year combinations were omitted as a consequence.  

Economic activity is typically lower on weekends compared to weekdays, and electricity demand is commensurately lower. To remove this noise, which is unrelated to temperature, weekends were omitted. 

Plotting the energy demand against temperature gives the Temperature-Load Curve (TLC). Depending on the climate and prevalence of heating and cooling appliances, the strength of the temperature-load profile will vary. Cities with distinct heating and cooling seasons (such as New York City, latitude = 40.65°, figure XX) will have a V shaped TLC. The right side of the curve represents the cooling regime: as temperatures increase, demand for electricity increases because of cooling requirements. The cooling regime, and therefore the city's sensitivity to high temperatures is characterized by a positive coefficient called the cooling coefficient. The left side of the curve represents the heating regime: as temperatures increase, demand for electricity increases because of heating requirements. It should be noted that in many cities, heating requirements are met predominately by natural gas or heating oil, and not electricity, although some electrical heating exists as well. Because our study focuses on electricity only, and no other fuels, our estimates of integral energy consumption for electrical heating  will certainly be underestimates of total heating energy in a city. 

The city's sensitivity for cold temperatures is characterized by a negative coefficient called the Heating Coefficient, which tends to be lower in absolute terms than the Cooling Coefficient for the reason stated above. The temperature that separates the cooling and the heating regime is called the Threshold Temperature. It is the transition between heating and cooling regimes. In other words, it is the observed 'comfortable' temperature above which people start cooling and under which people start heating. 

By contrast, cities in the tropics and sub-tropics tend to have cooling but no significant heating. For example, Dakar Senegal (latitude = 14.7°) has a distinct cooling seasons as can be seen from the TLC (figure XX). 

A third category is cities located in temperate climates with little to no cooling and heating infrastructure and thus no strong relationship between temperature and load. The TLC for these cities will lack a definite Threshold Temperature and the slope of the regression will not be significantly different than zero. As we will see in the result section, several cities have very recently transitioned from non-significant to significant Heating & Cooling, which indicates increased penetration of thermal-comfort appliances (see figures XX). 

```{r,fig.width=10, fig.height=5,echo=FALSE, eval=FALSE}
nyc <- hourly[which(hourly$city=="New York City" & hourly$yr==2012),]
dakar <- hourly[which(hourly$city=="Dakar" & hourly$yr==2012),]
p1 <- ggplot()+
  geom_point(data=nyc, aes(x=temperature, y=mw))+xlab("Temperature (°C)")+ylab("Demand (MW)")+labs(title="Temperature-load profile for NYC")+ylim(0,12500)+theme_bw() 
p2 <- ggplot()+
  geom_point(data=dakar,aes(x=temperature,y=mw))+xlab("Temperature (°C)")+ylab("Demand (MW)")+labs(title="Temperature-load profile for Dakar")+ylim(0,600)+theme_bw() 

pushViewport(viewport(layout = grid.layout(1, 2)))
print(p1, vp = viewport(layout.pos.row = 1, layout.pos.col = 1))
print(p2, vp = viewport(layout.pos.row = 1, layout.pos.col = 2))
```


### Cooling/Heating Power Demand 

This section aims to quantify the TLC for a set of global cities. Cities are divided in two groups: Heating *&* Cooling, and Heating *or* Cooling. For cities for heating or cooling only, a sample linear regression is used to model load as a function of temperature. For cities with heating and cooling, a segmented linear regression is performed where in two linear models (one for cooling, one for heating) are iteratively estimated to minimize the total sum of square root errors. The intercept (Beta0) and Beta coefficients (Beta1) for the two linear models are estimated simultaneously by ordinary least squares given an initial condition of the breakpoint between the two linear regressions. In physical terms, the breakpoint is the threshold temperature (or transition temperature) between heating and cooling seasons. For each city, the initial condition was set equal to the mean temperature observed in that city. 
Since a large number of city-year combinations are considered in this study, we developed R functions to automate the process. For every city-year combination, the first step of the algorithm is to compute the IQR (difference between the 75th percentile and the 25th percentile) of the temperature distribution. Empirically, we found that for cities with distinct heating and cooling seasons the IQR was higher than 6.8 and that cities with heating or cooling have a temperature IQR less than 6.8. 

Figure XX (below) shows the resulting linear regression fit for NYC and Dakar respectively. The coefficients (Heating and/or Cooling), their significance and the x-coordinate of the break-point (threshold temperature) are extracted and saved for every city at every year. This is done for all cities at daily peak load observations. 

```{r,echo=FALSE, fig.width=10, fig.height=5, message=FALSE, warning=FALSE}

nyc <- hourly[which(hourly$city=="New York City" & hourly$yr==2012),]
dakar <- hourly[which(hourly$city=="Dakar" & hourly$yr==2012),]

dakar <- ddply(dakar, .(city,yr,m,d), function(x) x[x$mw == max(x$mw),])
nyc <- ddply(nyc, .(city,yr,m,d), function(x) x[x$mw == max(x$mw),])
linear.dakar <- lm(mw~temperature,data=dakar)
linear.nyc <- lm(mw~temperature,data=nyc)
segmented.nyc <- segmented(linear.nyc, seg.Z=~temperature, psi=list(temperature=20), control=seg.control(display=FALSE))

par(mfrow=c(1,2))
t <- plot(nyc$temperature,nyc$mw, main="Segmented regression for NYC", xlab="Temperature (°C)", ylab="Peak Demand (MW)")+plot(segmented.nyc,add=TRUE,res=FALSE,link=TRUE,col="green",size=0.9)

q <- plot(dakar$temperature,dakar$mw, main="Linear regression for Dakar", xlab="Temperature (°C)", ylab="Peak Demand(MW)") + abline(linear.dakar,col="green")

# Now make this plot interactive and online. To do this, first instantiate a Plotly object:
library(plotly)
py <- plotly()

# And call the ggplotly() method to convert your ggplot2 plot into a Plotly plot:
r <- py$ggplotly(t)

# Your online, interactive, collaborative plot lives at this URL:
r$response$url

# pushViewport(viewport(layout = grid.layout(1, 2)))
# print(t, vp = viewport(layout.pos.row = 1, layout.pos.col = 1))
# print(q, vp = viewport(layout.pos.row = 1, layout.pos.col = 2))
```

This process is repeated for every hour of the day for each city-year combination, that is, fit a linear/segmented regression model to all the weekday/weekend midnight, 1ams, 2ams, etc. resulting in 24 TLCs for each city-year combination. This will be used in the next section to estimate integral energy consumption for heating and cooling. 

```{r,echo=FALSE,message=FALSE,warning=FALSE, fig.width=10, fig.height=10}
nyc <- hourly[(hourly$city=="New York City" & hourly$yr==2012),]
cc.list.yr <- dlply(nyc, .(city,yr,hr), function(x) getSeg.hr(x))

hourly.plot <- nyc
hourly.plot$hr <- as.factor(hourly.plot$hr)

par(mfrow=c(6,4))
par(oma=c(0,0,0,0))
par(mar=c(2,2,2,2)) #5,4,4,2
for (i in 1:length(levels(hourly.plot$hr))){  
  plot(hourly.plot$temperature[which(hourly.plot$hr==levels(hourly.plot$hr)[i])],hourly.plot$mw[which(hourly.plot$hr==levels(hourly.plot$hr)[i])], xlab="Temperature", ylab="MW", main=paste("NYC 2012, hour=",levels(hourly.plot$hr)[i],sep=""), ann=FALSE)
  if ((class(cc.list.yr[[i]])[[1]])[1]=="segmented"){
    plot(cc.list.yr[[i]], add=TRUE, res=FALSE, link=TRUE, col="green", size=6)
    } else if ((class(cc.list.yr[[i]])[[1]])[1]=="lm") {
    abline(cc.list.yr[[i]], col="green")    
    } else {
      next
    }
}
```

The coefficients (heating and/or cooling) obtained at every hour for every city-year combination are a measure of demand for thermal-comfort seeking, that is how much power is required to keep residents in city comfortable. Coefficients are expressed in MW/°C and therefore represent the incremental change in load for every 1°C change in threshold temperatures. In subsequent sections, the Cooling Coefficient will be referred to as the Cooling Demand and the Heating Coefficient as the Heating Demand. 

### Integral Energy Consumption for Heating and Cooling

After estimating the characteristic energy demand for cooling and heating at each hour of the day (0-23) for each year from the TLC, we can reconstruct integral energy consumption for thermal-comfort by multiplying energy demand per °C by the degree hours (equations 1 and 2). Before computing integral energy consumption, a data filter was applied to select city-year combinations containing the equivalent of at least 350 days of hourly observations. 350 days was chosen instead of 365 days to allow a modest tolerance for missing data (a maximum of 2 weeks of equivalent hourly observations).

$$
{(1) Cooling Energy_{city,yr}} = \sum_{hour=1}^{8760} max\left \{ Cooling Demand_{city,yr,hr}*(T_{observed,city,yr,hr} - T_{threshold,city,yr,hr}), 0 \right \}
$$

$$
{(2) Heating Energy_{city,yr}} = \sum_{hour=1}^{8760} max\left \{ Heating Demand_{city,yr,hr}*(T_{threshold,city,yr,hr}-T_{observed,city,yr,hr}), 0 \right \}
$$

Two important points must be noted concerning the above two equations. First,for any city-year-hour combination, if the Cooling Demand or Heating Demand is not significant at the 90% confidence interval, it is set to 0. Second, for cities with only heating or cooling, or no relationship at all, the threshold temperature is taken as the 5th percentile of the temperature distribution to avoid outliers. 

```{r cooling-heating-energy, echo=FALSE}
test <- ddply(hourly1.filtered, .(city, yr, hr), function(x) get.energy(x, gradients.hr.yr) )

test1 <- ddply(test, .(city, yr), summarize, consumption.gwh=round(sum(mw)/1000,2), heating.gwh=round(sum(heating)/1000,2), cooling.gwh=round(sum(cooling)/1000,2), heating.share=round(abs(sum(heating)/sum(mw)),3), cooling.share=round((sum(cooling)/sum(mw)),3))
```

## Results

The following section presents results and discussion for each of four stated research objectives. Taken together, our results represent the first comparative analysis of electrical heating and cooling demand at the city-scale, including both OECD and non-OECD member cities.  

### Cooling
A significant cooling signal was detected (90% confidence level) for 35 of 37 cities analyzed. The only cities without a clear cooling signal were Mbabane, Swaziland (elev. 1243m, lat. -26°, long. 31.3°) and Nairobi, Kenya (elev. 1661m , lat -1.3°, long. 36.8°). Both cities are at high elevation, with temperate climates and cool nights, suggesting that electrical cooling is unnecessary much of the year, and thus adoption of capital-intensive A/C is commensurately low. By comparison, Abidjan, Cote d'Ivoire had no detectable cooling signal as recently as 2010, but now has a highly significant (99% CI) cooling demand of approximately 3 Watts/(capita x °C), suggesting very recent uptake of cooling appliances. 

In Accra, Ghana, both the effect of temperature on electricity demand, and the significance of that effect are increasing year-on-year. Virtually across the board among non-OECD cities, this holds true: cooling demand, both city-wide and per-capita, are higher now (most recent year data is available) than even just a few years ago (first year data is available). The overall trend is positive, but not strictly monotonic, for Abidjan, Cote d'Ivoire; Accra, Ghana; Chandigarh, India; Dakar, Senegal; and Manila, Philippines; see Table 2 (city-wide) and Table 3 (per-capita). 

This suggests significant, latent, unmet demand for indoor thermal comfort services in emerging market cities. As incomes continue to rise, so will penetration of vapor-compression refrigeration window-units (e.g. A/C) and resistive electrical heaters in the near term, and central heating/cooling and reversible heatpumps in the mid- to long-term. Energy demand for cooling, dehumidification and heating will rise accordingly. How high it will ultimately go, is a central question of this research. 

As an upper-estimate, we can presuppose that demand for heating and cooling will reach eventual parity with OECD cities of similar climate on a Watt/(°C x capita) basis. That is, a similar level of indoor thermal comfort is expected once a certain level of affluence is attained. Integrating heating/cooling demand over expected HDH/CDH for a given city, yields a reasonable estimate of total annual energy consumption for indoor thermal comfort. This method can be used for historical, current-year or future projections by adjusting the per-capita heating/cooling demand (intensive margin) and heating/cooling-degree hours (extensive margin). Adjustments can be made to reflect change over time along the development spectrum (intensive margin) and the effects of climate change (extensive margin).

As a group, non-OECD cities (n=15) were found to have maxima per-capita cooling demands ranging from 0-12 W/(capita x °C) in all but three cities [^1]. By comparison, OECD cities (n=18) ranged from 10-140 W/(capita x °C). The median per-capita cooling demand was seven-times higher in OECD compared to non-OECD cities (40.8 versus 5.8 W/(°C x capita), respectively). The univariate distribution of per-capita cooling demands comparing OECD and non-OECD cities yields statistically distinct sets. <T Test OECD vs non-OECD>

The only OECD cities in our study with per-capita cooling demands similar to that of the non-OECD set, were Los Angeles, Sand Diego and Honolulu (at 11, 23 and 19 W/°C x capita, respectively). All three of these locals have very mild, coastal climates with annual average temperatures at a near-perfect 22°C. While climate clearly attenuates or accentuates the intensity of demand for thermal comfort, it cannot explain all the difference.  While L.A., San Diego and Honolulu have near perfect climates, they still have per-capita cooling demands 2-4 times higher than emerging economy cities with much more extreme climates, such as Delhi. Based on climate alone, we would expect the opposite.

Within the OECD set, there is substantial variation. Mid-size, relatively sprawling, U.S. cities such as Detroit, MI; Chattanooga, TN; and Omaha, NE; appear to have the highest per-capita demand for cooling, at approximately 100 W/(capita x °C). Population dense Singapore, on the other hand, has a cooling demand of just 13 W/(°C x capita) despite having seven times as many standardized CDH as Detroit, five times as many as Omaha, and three times as many as Chattanooga. In fact, Singapore has the highest number of standardized CDH of any city in our study, with over 70,000 per annum. Result 6 provides a summary table of per-capita peak demand for electrical cooling (and heating) alongside standardized and optimized CDH (HDH) for all cities in our study. 

Returning to the three non-OECD cities with substantially higher per-capita cooling demand than their peer-group, we have: Manila, Philippines at 19 W/(capita x °C); Amman, Jordan at 47 W/(capita x °C); and New Delhi (not NCT Delhi as a whole or any of the other districts; just the governmental district) at 40 W/(capita x °C). These three cities may be harbingers of what is to come among peer non-OECD cities analyzed in this study, as well as thousands of other emerging-market cities worldwide, as incomes rise and demand for indoor thermal comfort increases.

For example, New Delhi (NDMC; the seat of government), has a per-capita cooling demand roughly four times that of neighboring parts of the city. This reflects stark differences in the building stock: many large government buildings have been retrofitted for air-conditioning, a departure from traditional open-envelope building design. Cooling demand in neighboring districts of Delhi will likely catch up quickly, as A/C rapidly becomes commonplace in middle-income households and businesses in all quarters of the city. 

Amman, Jordan has per-capita cooling demand nine times as high as Beirut, although the cities are less than a 150 miles apart and have similar climates (although Beirut is more temperate given its location on the Mediterranean). Cooling demand in Amman is more similar to that of El Paso, TX, USA at 56 W/(capita x °C), than nearby Beirut. 

Altogether, 15 of 37 cities were found to have statistically significant growth (90% CI) in cooling demand over the period of record, including all non-OECD cities except Beirut and Delhi. 11 of 15 of these cities experienced the highest cooling demand on record in the most recent year. This suggests continued, increasing penetration of air conditioning and increasing square-footage of air-conditioned space. The former is likely the driving force in seven non-OECD cities (Abidjan, Cote d'Ivoire; Accra, Ghana; Chandigarh, India; Dakar, Senegal; New Delhi, India; Delhi Military Contonement, India; and Manila, Philippines), whereas the latter is more likely in the four OECD cities (New York City, USA; Philadelphia, USA; Tacoma, USA; Indianapolis, USA.). That is to say, business and residences in non-OECD cities are rapidly adopting A/C, whereas non-OECD cities have already reached market saturation for A/C ownership, but continue to build and convert new square-feet into residential/commercial air-conditioned space. In both cases, demand for thermal comfort continues to rise, suggesting a long-tailed distribution. Even after emerging market cities reach asymptotic adoption rates for heating and cooling appliances, energy demand will continue to rise, following a development pattern of increasing residential/commercial air-conditioned real-estate.

From a system-operator perspective, total urban demand for electrical cooling ranges from less than 10 MW/°C in Abidjan, Accra, Antigua, Beirut, Chandigarh, Dakar, Kano and Tema, to over 2000 MW/°C in Tokyo, 300 MW/°C in NYC and Detroit, and ~200 MW/°C in Philadelphia and Manila. Of course, population and economy explain much of that difference, but large disparities remain even on a per-capita basis, as noted above and illustrated in Tables 3 and 4.

[^1]: Manila, Philippines at 19 W/(capita x °C); Amman, Jordan at 47 W/(capita x °C); and New Delhi (not to be confused with Old Delhi nor NCT Delhi as a whole; only the relatively new governmental district) at 40 W/(capita x °C).

### Heating
A significant heating signal was detected (90% confidence level) for 22 of 37 cities analyzed: As temperatures decrease below an empirically-derived threshold temperature (unique to each city), electrical demand increases. That is, an inverse-linear relationship is observed between temperature and electricity demand below a the threshold temperature, typically 15-25°C, depending on the city. Cities with no significant heating signal fall into two categories: (1) tropical, coastal or otherwise mild climates with little need for heating, and (2) cities that do require heating for indoor thermal comfort during parts of the year, but have yet to reach significant penetration rates of heating appliance ownership. Category two are of particular interest because they will undoubtedly change significantly over the next several years and decades as incomes rise, the cost of heating appliances come down, and western living standards are sought. 

Many non-OECD cities, which are of particular interest in this study, fall into one of the two aforementioned categories. Non-OECD cities that do indeed have significant heating signals include Amman at 28.3 W/(capita x °C), Beirut at 0.3, Chandigarh at 2.1, Delhi W-SW-S [districts](#anchor1) at 1, Delhi Military Contonement at 7, Delhi NW-N [districts](#anchor1) at 0.8, Mbabane at 3.6 and Nairobi at 0.4 W/(capita x °C). Interestingly, in Chandigarh and Nairobi, per-capita heating demand were not significantly different from zero as recently as 2011, but have since become significant and increased year-on-year in each of the past three years. We expect this trend to continue (increasing demand, but not strictly monotonic) for years to come as more households and businesses adopt electrical space heating.

<Continue Here>

```{r summary table, echo=FALSE, eval=FALSE}
# demand <- gradients.all.max.yr[,c("city","yr","heating","sig.heating","cooling","sig.cooling")]
# energy <- test1[,c("city","yr","heating","cooling")]
# colnames(energy)[3:4] <- c("heating.e","cooling.e")
# 
# summary.t <- merge(demand, energy, by=c("city","yr"), all=TRUE)

summary.gradients <- ddply(gradients.all.max.yr,.(city), function(x) x[x$yr == max(x$yr),]) 
summary.gradients[,3] <- round(summary.gradients[,3],0)
summary.gradients[,c(4:6)] <- round(summary.gradients[,c(4:6)],2)
summary.energy <- ddply(test1,.(city), function(x) x[x$yr == max(x$yr),]) 
```

```{r population-reshape, echo=FALSE, message=FALSE, warning=FALSE}
population <- population[,c(1,8:16)]
colnames(population)[2:10] <- c(2006:2014)
population <- melt(population, id.vars = "city")
colnames(population)[2:3] <- c("yr","pop")
population$yr <- as.numeric(as.character(population$yr))
population <- na.omit(population)
population$pop <- as.numeric(population$pop)
population$yr <- as.integer(population$yr)
```

**Result 1:** Urban peak demand for electrical heating and cooling in MW/(∆T) 
```{r sparkTable, echo=FALSE}
gradients <- gradients.all.max.yr
gradients[,c(2:8)] <- round(gradients[,c(2:8)],2) 

# Replacing unsignificant coefficients with 0
for (i in 1:nrow(gradients)){
  if (gradients$sig.heating[i]>0.1 | is.na(gradients$sig.heating[i])){
    gradients$heating[i] <- 0 }
  if (gradients$sig.cooling[i]>0.1 | is.na(gradients$sig.cooling[i])){
    gradients$cooling[i] <- 0
  }
}
# 
# gradients.count <- count(gradients$city)
# get.cities <- as.character(gradients.count$x[gradients.count$freq>1])
# 
# # Creating the useful dataframe
# gradients1 <- expand.grid(get.cities,2006:2014)
# colnames(gradients1) <- c("city","yr")
# gradients1$cooling <- NA
# gradients1$heating <- NA
# 
# # Filling the useful dataframe
# for(i in 1:nrow(gradients1)){
#   if(any(gradients$yr==gradients1$yr[i]&gradients$city==as.character(gradients1$city[i]))){
#     gradients1$cooling[i] <-
# gradients$cooling[gradients$yr==gradients1$yr[i]&gradients$city==as.character(gradients1$city[i])]
#     gradients1$heating[i] <-
# gradients$heating[gradients$yr==gradients1$yr[i]&gradients$city==as.character(gradients1$city[i])]
#   }
# }
# 
# gradients1 <- gradients1[order(gradients1$city),]
# gradients1$year <- gradients1$yr
# gradients1 <- reshapeExt(gradients1,idvar='city',timevar='yr',varying=list(3,4)) 
# gradients1.test <- na.omit(gradients1)
# 
# content <- list(
#     function(x) { paste(min(x), max(x), sep=" - " )}, # range years 
#     function(x) { paste(min(x))}, # min heating
#     function(x) { paste(max(x))}, # max heating
#     newSparkLine(height = 0.25, width = 1, pointWidth = 2, lineWidth = 1),           # heating demand timeseries
#     function(x) { paste(min(x))}, # min cooling
#     function(x) { paste(max(x))}, # max cooling
#     newSparkLine(height = 0.25, width = 1, pointWidth = 2, lineWidth = 1)            # cooling demand timeseries
#     )
# 
# names(content) <- c(" Year Range ","Min Heating","Max Heating","Heating Trend"," Min Cooling","Max Cooling","Cooling Trend") 
# varType <- c("year","heating","heating","heating","cooling","cooling","cooling")
# 
# x1 <- newSparkTable(gradients1.test, content, varType)
# setwd("~/Google Drive/global_trends/GTUCH/latex_tables/demand_overall/")
# # suppressMessages(export(x1,outputType="html",infonote=FALSE))
# suppressMessages(export(x1,outputType="tex",infonote=TRUE))
```

```{r, results='asis',eval=FALSE}
# gradients.one <- gradients[!gradients$city%in%get.cities,c(1,2,4,5)]
# colnames(gradients.one) <- c("City","Year","Heating Demand [MW/DeltaT]","Cooling Demand [MW/DeltaT]")
# kable(gradients.one)
```

```{r, echo=FALSE}
setwd("~/Google Drive/global_trends/GTUCH/")
```

![Urban peak demand for electrical heating and cooling](latex_tables/peak-absolute.png)

*Footnote: [1] 0-values represent beta coefficients that we feel to reject as different from zero at the 90% confidence level. [2]: maximum = green dot; minimum = red dot; latest value = blue dot.*



**Result 2:** Per-capita peak demand for electrical heating and cooling in W/(∆T x capita) 
```{r sparkTable.percap, echo=FALSE}
gradients <- merge(gradients, population, by=c("city","yr"), all=TRUE)
gradients <- gradients[,c(1,2,4,5,9)]
gradients$cooling <- gradients$cooling/gradients$pop*10^6 #in W
gradients$heating <- gradients$heating/gradients$pop*10^6 #in W
gradients <- gradients[,c(1:4)]
gradients <- na.omit(gradients)

# gradients.count <- count(gradients$city)
# get.cities <- as.character(gradients.count$x[gradients.count$freq>1])
# 
# # Creating the useful dataframe
# gradients1 <- expand.grid(get.cities,2006:2014)
# colnames(gradients1) <- c("city","yr")
# gradients1$cooling <- NA
# gradients1$heating <- NA
# 
# # Filling the useful dataframe
# for(i in 1:nrow(gradients1)){
#   if(any(gradients$yr==gradients1$yr[i]&gradients$city==as.character(gradients1$city[i]))){
#     gradients1$cooling[i] <-
# gradients$cooling[gradients$yr==gradients1$yr[i]&gradients$city==as.character(gradients1$city[i])]
#     gradients1$heating[i] <-
# gradients$heating[gradients$yr==gradients1$yr[i]&gradients$city==as.character(gradients1$city[i])]
#   }
# }
# 
# gradients1 <- gradients1[order(gradients1$city),]
# gradients1$year <- gradients1$yr
# gradients1 <- reshapeExt(gradients1,idvar='city',timevar='yr',varying=list(3,4)) 
# gradients1.test <- na.omit(gradients1)
# 
# # names(content) <- c(" Year Range ","Heating Range min/max [W/deltaT*Capita]","Heating Trend"," Cooling Range min/max [MW/deltaT*Capita] ","Cooling Trend") 
# # varType <- c("year","heating","heating","cooling","cooling")
# 
# gradients1.test[,c(4,5)] <- round(gradients1.test[,c(4,5)],2)
# 
# x2 <- newSparkTable(gradients1.test, content, varType)
# setwd("~/Google Drive/global_trends/GTUCH/latex_tables/demand_capita/")
# suppressMessages(export(x2,outputType="tex",infonote=TRUE))
```

```{r, results='asis',eval=FALSE}
# gradients.two <- gradients[!gradients$city%in%get.cities,c(1:4)]
# colnames(gradients.two) <- c("City","Year","Heating Demand [W/DeltaT*Capita]","Cooling Demand [W/DeltaT*Capita]")
# kable(gradients.two)
```

![Per-capita peak demand for electrical heating and cooling](latex_tables/peak-capita.png)

** Result 3** Penetration of heating and cooling appliances 

```{r penetration.abidjan, echo=FALSE, fig.height=3}
abidjan.yr <- c(2011, 2012, 2013)
df.abidjan <- hourly[hourly$city=="Abidjan" & hourly$yr%in%abidjan.yr,]
df.abidjan <- ddply(df.abidjan, .(city, yr, m, d), function(x) x[x$mw == max(x$mw),])

gradients.abidjan <- gradients.all.max.yr[gradients.all.max.yr$city=="Abidjan" & gradients.all.max.yr$yr%in%abidjan.yr,]

ggplot()+
  geom_point(data=df.abidjan, aes(x=temperature, y=mw))+
  geom_abline(data=gradients.abidjan, aes(slope=cooling,intercept=intercept, color='red'))+
  facet_wrap(city~yr, scales='fixed')+
  labs(x="Temperature [°C]", y="Daily Peak Load [MW]")+
  theme_bw()
```

```{r penetration.accra, echo=FALSE, fig.height=3, eval=FALSE}
df.accra <- hourly[hourly$city=="Accra",]
df.accra <- ddply(df.accra, .(city, yr, m, d), function(x) x[x$mw == max(x$mw),])

gradients.accra <- gradients.all.max.yr[gradients.all.max.yr$city=="Accra",]

ggplot()+
  geom_point(data=df.accra, aes(x=temperature, y=mw))+
  geom_abline(data=gradients.accra, aes(slope=cooling,intercept=intercept, color='red'))+
  facet_wrap(city~yr, scales='free')+
  labs(x="Temperature [°C]", y="Daily Peak Load [MW]")+
  theme_bw()
```

```{r penetration.dakar, echo=FALSE, fig.height=3}
dakar.yr <- c(2012, 2013, 2014)
df.dakar <- hourly[hourly$city=="Dakar" & hourly$yr%in%dakar.yr,]
df.dakar <- ddply(df.dakar, .(city, yr, m, d), function(x) x[x$mw == max(x$mw),])

gradients.dakar <- gradients.all.max.yr[gradients.all.max.yr$city=="Dakar" & gradients.all.max.yr$yr%in%dakar.yr,]

ggplot()+
  geom_point(data=df.dakar, aes(x=temperature, y=mw))+
  geom_abline(data=gradients.dakar, aes(slope=cooling,intercept=intercept, color='red'))+
  facet_wrap(city~yr, scales='fixed')+
  labs(x="Temperature [°C]", y="Daily Peak Load [MW]")+
  theme_bw()
```

```{r penetration.manila, echo=FALSE, fig.height=3}
manila.yr <- c(2011, 2012, 2013)
df.manila <- hourly[hourly$city=="Manila" & hourly$yr%in%manila.yr,]
df.manila <- ddply(df.manila, .(city, yr, m, d), function(x) x[x$mw == max(x$mw),])

gradients.manila <- gradients.all.max.yr[gradients.all.max.yr$city=="Manila" & gradients.all.max.yr$yr%in%manila.yr,]

ggplot()+
  geom_point(data=df.manila, aes(x=temperature, y=mw))+
  geom_abline(data=gradients.manila, aes(slope=cooling,intercept=intercept, color='red'))+
  facet_wrap(city~yr, scales='fixed')+
  labs(x="Temperature [°C]", y="Daily Peak Load [MW]")+
  theme_bw()
```



**Result 4:** Per-capita integral energy consumption for heating & cooling, and normalized energy consumption for heating and cooling. 

**Note: The following cities/years were lost as a consequence of the 350-days filter: Abidjan-2010, Accra-2013, Beirut-2011, Beirut-2012, Beirut-2013, Beirut-2014, Chandigarh-2011, Chandigarh-2013, Kano-2014, Nairobi-2011, Nairobi-2012, New York City-2007, New York City-2008, New York City-2009, Sacramento-2006, San Diego-2012, San Diego-2013, Tacoma-2006, Tema-2014. ** 

```{r, fig.height=8, fig.width=8}
energy <- test1
pop <- population

# combine energy and population data
energy <- merge(energy, pop, by=c("city","yr"))
energy$pop <- as.numeric(energy$pop)

# compute per capita energy consumption (total, cooling, heating)
energy$consumption.percap.kwh <- round(energy$consumption.gwh/(energy$pop/10^6), 2)
energy$cooling.gwh <- round(energy$cooling.gwh/energy$pop*10^6,2)
energy$heating.gwh <- round(energy$heating.gwh/energy$pop*10^6,2)

# grab the most recent year
energy.recent <- ddply(energy, .(city), function(x) x[x$yr == max(x$yr),])

# compute share of energy consumption *not* for thermal comfort (e.g. "other")
energy.recent$other.share <- 1 - (energy.recent$cooling.share + energy.recent$heating.share)
energy.recent$other.gwh <- energy.recent$consumption.percap.kwh - (energy.recent$cooling.gwh + energy.recent$heating.gwh)

# order from highest to lowest percentage share of energy for thermal comfort
energy.recent <- energy.recent[order(energy.recent$other.share, decreasing = FALSE),]

# subset and melt for ggplot()
gwh <- subset(energy.recent, select=c("city", "yr", "pop", "other.share" ,"cooling.gwh", "heating.gwh")) #, "other.gwh"
colnames(gwh) <- c("city", "yr", "pop", "climate.independent.share", "cooling", "heating") #, "climate-independent"
gwh.melt <- melt(gwh, id.vars = c("city", "yr", "pop", "climate.independent.share"))


# order from highest to lowest percentage share of energy for thermal comfort
gwh.melt <- gwh.melt[order(gwh.melt$city, decreasing = FALSE),]
# repeat for normalized energy

## plot
ggplot(gwh.melt, aes(x=city, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  theme_bw() +
  labs(title="Per Capita Energy for Thermal Comfort", y="KWh/(capita x year)")+
  coord_flip() +
  scale_y_continuous(expand=c(0,0)) +
  scale_fill_manual(values=c("blue", "red"))+ #, "gray"
  theme(legend.position="bottom")
  # scale_fill_brewer("Energy Consumption", type="qual")
```

```{r normalized.cooling.share, fig.height=8, fig.width=8}
# **Result 5:** Normalized per-capita integral energy consumption for heating & cooling 
normalized <- subset(energy.recent, select=c("city", "yr", "pop", "cooling.share", "heating.share", "other.share"))
colnames(normalized) <- c("city", "yr", "pop", "cooling", "heating", "climate-independent")
normalized.melt <- melt(normalized, id.vars = c("city", "yr", "pop"))

# gwh.melt$type <- "gwh"
# normalized.melt$type <- "melt"
# 
# gwh.melt <- gwh.melt[,c("city","yr","variable","value","type")]
# normalized.melt <- normalized.melt[,c("city","yr","variable","value","type")]
# 
# combined <- rbind(gwh.melt, normalized.melt)
# 
# ggplot(combined, aes(x=city, y=value, fill=variable)) +
#   geom_bar(stat="identity") + 
#   theme_bw() +
#   labs(title="Fraction of Total Energy Consumption", y="Fraction of Total") +
#   scale_y_continuous(expand=c(0,0)) + 
#   scale_fill_manual(values=c("blue", "red", "gray")) +
#   theme(legend.position="bottom") +
#   facet_grid(~type, scales="free_y") +
#   coord_flip()

# facet_wrap(~type, scales="free")+


# plot
ggplot(normalized.melt, aes(x=city, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  theme_bw() +
  labs(title="Fraction of Total Energy Consumption For Thermal Comfort", y="Fraction of Total") +
  coord_flip() +
  scale_y_continuous(expand=c(0,0)) +
  scale_fill_manual(values=c("blue", "red", "gray")) +
  theme(legend.position="bottom")


# pushViewport(viewport(layout = grid.layout(1, 2)))
# print(i1, vp = viewport(layout.pos.row = 1, layout.pos.col = 1))
# print(i2, vp = viewport(layout.pos.row = 1, layout.pos.col = 2))
```

**Result 5: Total per-capita electricity consumption**
```{r per.capita.energy.consumption, fig.height=8, fig.width=8}

consumption.per.cap <- subset(energy.recent, select=c("city","yr","consumption.percap.kwh"))
consumption.per.cap.melt <- melt(consumption.per.cap, id.vars = c("city","yr"))
consumption.per.cap.melt <- consumption.per.cap.melt[order(consumption.per.cap.melt$city, decreasing = FALSE),]

# plot
ggplot(consumption.per.cap.melt, aes(x=city, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  theme_bw() +
  labs(title="Per-Capita Energy Consumption", y="KWh") +
  coord_flip() +
  scale_y_continuous(expand=c(0,0)) +
  scale_fill_manual(values=c("gray")) +
  theme(legend.position="bottom")
```

**Result 6:** Summary Table of Per-Capita Peak Demand and Integral Energy Consumption for Thermal Comfort
```{r summary-table, echo=FALSE}
# Mean Coefs
gradients.t <- ddply(gradients, .(city), summarize, heating.d=round(mean(heating),2), cooling.d=round(mean(cooling),2))
gradients.t$city <- as.factor(gradients.t$city)

# Mean Energy
energy.t <- ddply(energy, .(city), summarize, heating.e=round(mean(heating.gwh),2), cooling.e=round(mean(cooling.gwh),2))
energy.t$city <- as.factor(energy.t$city)

# Get & Mean Optimized CDH/HDH
city.dh <- ddply(hourly1.filtered, .(city,yr), function(x) get.cdh.hdh(x,gradients.all.max.yr))
city.dh <- ddply(city.dh, .(city), summarize, hdh=round(mean(hdh),0), cdh=round(mean(cdh),0))
city.dh$city <- as.factor(city.dh$city)

# Get & Mean Standardized CDH/HDH
city.dh.standard <- ddply(hourly1.filtered, .(city,yr), function(x) get.cdh.hdh.standard(x,20))
city.dh.standard <- ddply(city.dh.standard, .(city), summarize, hdh=round(mean(hdh),0), cdh=round(mean(cdh),0))
city.dh.standard$city <- as.factor(city.dh.standard$city)
colnames(city.dh.standard)[c(2,3)] <- c("hdh.s","cdh.s")

# Get & Mean TT
hourly.temp <- hourly
hourly.temp$city.yr <- paste(hourly.temp$city, hourly.temp$yr, sep="-")
gradients.city.yr <- levels(as.factor(paste(gradients.all.max.yr$city, gradients.all.max.yr$yr,sep="-")))
hourly.temp <- hourly.temp[hourly.temp$city.yr %in% gradients.city.yr,]
tt.df1 <- ddply(hourly.temp, .(city,yr), function(x) get.tt(x, gradients.all.max.yr))
tt.df <- ddply(tt.df1, .(city), summarize, t.t=mean(t.t))

# Merge everything
summary.t <- merge(gradients.t, energy.t, by="city",all=TRUE)# city.dh.tt, by="city", all=TRUE)
summary.t <- merge(summary.t, tt.df, by="city",all=TRUE)
summary.t <- merge(summary.t, city.dh,by="city",all=TRUE)
summary.t <- merge(summary.t, city.dh.standard, by="city", all=TRUE)

summary.t <- summary.t[,c("city","hdh","hdh.s","heating.d","heating.e","t.t","cdh","cdh.s","cooling.d","cooling.e")]
summary.t[is.na(summary.t)] <- "-"
colnames(summary.t) <- c("City","Optimized HDH","Standard HDH","Heating Demand [W/(°C x Capita)]","Heating Energy [kWh/(capita x yr)]","Threshold Temperature","Optimized CDH","Standard CDH","Cooling Demand [W/(°C x capita)]","Cooling Energy [kWh/(capita x yr)]")
```

```{r, results='asis'}
kable(summary.t, digits = 2)
```

*Footnote: Optimized HDH/CDH are calculated from the drived city-specific Threshold Temperature. Standard HDH/CDH are calculated assuming a 20°C baseline Threshold Temperature*


**Result 7:** Urban Peak Load Analysis
```{r cooling-share-of-demand, echo=FALSE}
# Get years included in gradients.all.max.yr, then get most recent years 
hourly.temp <- hourly
hourly.temp$city.yr <- paste(hourly.temp$city, hourly.temp$yr, sep="-")
gradients.city.yr <- levels(as.factor(paste(gradients.all.max.yr$city, gradients.all.max.yr$yr,sep="-")))
hourly.temp <- hourly.temp[hourly.temp$city.yr %in% gradients.city.yr,]
hourly.temp <- ddply(hourly.temp, .(city), function(x) x[x$yr==max(x$yr),])

# In the above selected years, get the cooling season
hourly.temp1 <- hourly.temp
hourly.temp1 <- merge(hourly.temp1, tt.df1, by=c("city","yr"))
hourly.temp1$delta <- hourly.temp1$temperature - hourly.temp1$t.t
hourly.temp1 <- hourly.temp1[hourly.temp1$delta>0,]

# Get the cooling season peak load
hourly.temp1 <- ddply(hourly.temp1, .(city, yr), function(x) x[x$mw==max(x$mw),])
hourly.temp1 <- hourly.temp1[,c(1:7,11)]

# Subset cooling demand
gradients.df <- gradients.all.max.yr[,c("city","yr","cooling","sig.cooling")]
for (i in 1:nrow(gradients.df)){
  if (is.na(gradients.df$sig.cooling[i]) | gradients.df$sig.cooling[i]>0.1){
    gradients.df$cooling[i] <- 0
  }
}
gradients.df <- gradients.df[,c("city","yr","cooling")]

# Calculate the cooling demand and share
summary.t.1 <- merge(hourly.temp1, gradients.df, by=c("city","yr"))
summary.t.1$mw.cooling <- round(summary.t.1$cooling*(summary.t.1$temperature-summary.t.1$t.t),2)
summary.t.1$perc.cooling <- round(summary.t.1$mw.cooling/summary.t.1$mw*100,2)

# Get date
summary.t.1$date <- as.Date(paste(hourly.temp1$yr, hourly.temp1$m, hourly.temp1$d, sep=c("/","/")))

summary.t.1 <- summary.t.1[,c("city","date","hr","temperature","mw","mw.cooling","perc.cooling")]
colnames(summary.t.1) <- c("City","Date","Hour","Temperature [°C]","Peak Demand [MW]","Peak Cooling Demand [MW]","% Demand for Cooling")
```

```{r, results='asis'}
kable(summary.t.1, digits = 2)
```


***

Appendix
--------------
#### [Delhi DISCOM to District Mapping](id:anchor1)

| DISCOM | Districts    | 
|:-------|:-------------|
|NDMC    | New Delhi    |  
|MES     | Military     | 
|BRPL    | W-SW-S       |
|BYPL    | NE-E-Central |
|NDPL    | NW-N         |

References
---------------
[1] Segal M., Shafer H., Mandel M.. Alpert P., & Balmor V. (1992). Climatic-related evaluations of the summer peak-hours’ electrical load in Israel. *Journal of Applied Meteorology*, 31, 1492-1498.  
[2] Christian Crowley., & Frederick L. Joutz. (2003). Hourly electricity loads: temperature elasticities and climate change. 23rd US Association of Energy Economics North American Conference.  
[3] Marcus J. Thatcher. (2007). Modeling changes to electricity demand load duration curves as a consequence of predicted climate change for Australia. *Energy*, 32, 1647-1659.   
[4] Bose, R.K., & M. Shukla. (1999). Elasticities of electricity demand in India. *Energy Policy*, 27(3), 137-146.   
[5] Tiwari, P. (2000). Architectural, demographic, and economic causes of electricity consumption in Bombay. *Journal of Policy Modelling* 22(1), 81–98.  
[6] Shonali Pachauri. (2004). An analysis of cross-sectional variations in total household energy requirements in India using micro survey data. *Energy Policy*, 32, 1723-1735. 
[7] The World Bank. (2008). Residential Consumption of Electricity in India: Documentation of Data and Methodology.  
[8] Pachauri, S. & Spreng, D. (2004) Energy Use and Energy Access in Relation to Poverty. *Economic and Political Weekly*, Vol. 39, No. 3 (Jan. 17-23, 2004), pp. 271-278  
[9] Gupta, (2012). Global Warming and Electricity Demand in the Rapidly Growing City of Delhi: A Semi-Parametric Coefficient Approach, *Energy* <INCOMPLETE>  
[10] Gupta, (2014). The Effect Of Development on the Climate Sensitivity of Electricity in India, Discussion Papers in Economics, Indian Statistical Institute, Delhi, India  
[11] David J. Sailor., J, Ricardo Munoz. (1997). Sensitivity of electricity and natural gas consumption to climate in the USA—methodology and results for eight states. *Energy*, 22(10), 987-998.   
[12] Joshua D. Rhodes., Wesley J. Cole., Charles R. Upshaw., Thomas F. Edgar., & Michael E. Webber. Clustering analysis of residential electricity demand profiles. *Applied Energy*, 135, 461-471.   
[13] Heck, S. & Rogers, M. (2014). Resource Revolution (1st Edition). New York: Houghton Mifflin Harcourt  
[14] Smit,Remes, Manyika, Roxburgh, Restrepo (2011). Urban world: Mapping the economic power of cities. McKinsey Global Institute.  
[15] IEA World Energy Outlook 2014 Fact sheet   
[16] Austin Energy. (2006). Residential Electricity burden: an investigation of American community survey data. <INCOMPLETE>  
[17] David J. Sailor., J, Ricardo Munoz. (1997). Sensitivity of electricity and natural gas consumption to climate in the USA—methodology and results for eight states. Energy, 22(10), 987-998.  
[18] Energy Information Administration. Electricity Power Monthly. http://www.eia.gov/ electricity/monthly/index.cfm   
[19] Huang, Y. J., Ritschard, R., Bull, J., Chang, L. (1986), Climatic indicators for estimating residential heating and cooling loads. Lawrence Berkeley Laboratory, Report LBL-21 I01, Berkeley, CA.  
[20] Joshua D. Rhodes., Wesley J. Cole., Charles R. Upshaw., Thomas F. Edgar., & Michael E. Webber. Clustering analysis of residential electricity demand profiles. *Applied Energy*, 135, 461-471.  
[21] Li, X., Sailor, D.J.,(1995). Electricity use sensitivity to climate and climate change. *World Resource*, 7(3), 334-346.  
[22] Massimo Filippini., & Shonali Pachauri. (2004). Elasticities of electricity demand in urban Indian households. *Energy Policy*, 32, 429-436.  
[23] Sailor DJ. (2001). Relating residential and commercial sector electricity loads to climate —evaluating state level sensitivities and vulnerabilities. *Energy*, 26, 645-657.  
[24] Scott, M.J., Wrech, L.E., Hadley, D.L. (1994). Effects of Climate Change on Commercial Building Energy Demand. *Energy Sources*, 16, 317-332.  
[25] S. Mirasgedis., Y. Sarafidis., E. Georgopoulou., D.P. Lalas., M. Moschovits., F. Karagiannis., D. Papakonstantinou. (2006). Models for mid-term electricity demand forecasting incorporating weather influences. *Energy*, 31: 208–227.  
[26] U.S. Census Bureau. (1995-present). American Community Survey. http://www.census.gov/acs/  
[27] U.S. Census Bureau. Working at home is on the rise. http://www.census.gov/newsroom/releases/pdf/home_based_workers_us_infographic.pdf  
[28] Commoner, Barry. “The Environmental Cost of Economic Growth.” in Population, Resources and the Environment. Washington, DC: Government Printing Office Pp. 339-63, 1972
[29] Edmonds, J., M. Wise, H. Pitcher, R. Richels, T. Wigley, and C. MacCracken. (1997) “An Integrated Assessment of Climate Change and the Accelerated Introduction of Advanced Energy Technologies”, Mitigation and Adaptation Strategies for Global Change, 1, pp. 311-39.















